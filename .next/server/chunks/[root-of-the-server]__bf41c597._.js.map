{"version":3,"sources":["../../../../biblical-truth-website/lib/db.ts"],"sourcesContent":["import { neon } from '@neondatabase/serverless';\n\nconst sql = neon(process.env.POSTGRES_URL!);\n\n// ========== EXISTING FUNCTIONS (MODIFIED TO RETURN ID) ==========\nexport async function createUser(email: string, passwordHash: string) {\n    try {\n        const result = await sql`\n      INSERT INTO users (email, password, status)\n      VALUES (${email}, ${passwordHash}, 'active')\n      ON CONFLICT (email) DO UPDATE SET status = 'active'\n      RETURNING id;\n    `;\n        return result[0];\n    } catch (error) {\n        console.error('Failed to create user:', error);\n        return null;\n    }\n}\n\nexport async function getUser(email: string) {\n    try {\n        const result = await sql`SELECT * FROM users WHERE email=${email}`;\n        return result[0];\n    } catch (error) {\n        console.error('Failed to fetch user:', error);\n        return null;\n    }\n}\n\n// ========== NEW MEMBERSHIP FUNCTIONS ==========\n\n/**\n * Creates a membership record for a user\n * Called by Stripe webhook after successful payment\n */\nexport async function createMembership(\n    userId: number,\n    membershipType: string = 'gate_pass',\n    stripeSessionId?: string\n) {\n    try {\n        await sql`\n      INSERT INTO memberships (user_id, membership_type, status, stripe_session_id)\n      VALUES (${userId}, ${membershipType}, 'active', ${stripeSessionId || null})\n      ON CONFLICT (user_id, membership_type)\n      DO UPDATE SET status = 'active', stripe_session_id = ${stripeSessionId || null};\n    `;\n        return true;\n    } catch (error) {\n        console.error('Failed to create membership:', error);\n        return false;\n    }\n}\n\n/**\n * Checks if a user has an active gate pass membership\n * Used by middleware and route protection\n */\nexport async function userHasGatePass(userId: number): Promise<boolean> {\n    try {\n        const result = await sql`\n      SELECT * FROM memberships\n      WHERE user_id = ${userId}\n      AND membership_type = 'gate_pass'\n      AND status = 'active'\n      LIMIT 1;\n    `;\n        return result.length > 0;\n    } catch (error) {\n        console.error('Failed to check membership:', error);\n        return false;\n    }\n}\n\n/**\n * Checks if email has an active gate pass (for simpler cookie-based auth)\n */\nexport async function emailHasGatePass(email: string): Promise<boolean> {\n    try {\n        const result = await sql`\n      SELECT m.* FROM memberships m\n      JOIN users u ON u.id = m.user_id\n      WHERE u.email = ${email}\n      AND m.membership_type = 'gate_pass'\n      AND m.status = 'active'\n      LIMIT 1;\n    `;\n        return result.length > 0;\n    } catch (error) {\n        console.error('Failed to check membership by email:', error);\n        return false;\n    }\n}\n\n/**\n * Get user by ID (needed for middleware checks)\n */\nexport async function getUserById(userId: number) {\n    try {\n        const result = await sql`SELECT * FROM users WHERE id=${userId}`;\n        return result[0];\n    } catch (error) {\n        console.error('Failed to fetch user by ID:', error);\n        return null;\n    }\n}\n\n/**\n * Get user's membership details\n */\nexport async function getUserMembership(userId: number) {\n    try {\n        const result = await sql`\n      SELECT * FROM memberships\n      WHERE user_id = ${userId}\n      AND membership_type = 'gate_pass'\n      ORDER BY created_at DESC\n      LIMIT 1;\n    `;\n        return result[0] || null;\n    } catch (error) {\n        console.error('Failed to fetch membership:', error);\n        return null;\n    }\n}\n"],"names":[],"mappings":"8iCAEA,IAAM,EAAM,CAAA,EAAA,AAFZ,EAAA,CAAA,CAAA,OAEY,IAAA,AAAI,EAAC,QAAQ,GAAG,CAAC,YAAY,EAGlC,eAAe,EAAW,CAAa,CAAE,CAAoB,EAChE,GAAI,CAOA,MAAO,CANQ,MAAM,CAAG,CAAC;;cAEnB,EAAE,EAAM,EAAE,EAAE,EAAa;;;KAGnC,AAAC,CACgB,CAAC,EAClB,AADoB,CAClB,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,yBAA0B,GACjC,IACX,CACJ,CAEO,eAAe,EAAQ,CAAa,EACvC,GAAI,CAEA,MAAO,CADQ,MAAM,CAAG,CAAC,gCAAgC,EAAE,GAAM,AAAC,CACrD,CAAC,EAAE,AACpB,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,wBAAyB,GAChC,IACX,CACJ,CAQO,eAAe,EAClB,CAAc,CACd,EAAyB,WAAW,CACpC,CAAwB,EAExB,GAAI,CAOA,OANA,MAAM,CAAG,CAAC;;cAEJ,EAAE,EAAO,EAAE,EAAE,EAAe,YAAY,EAAE,GAAmB,KAAK;;2DAErB,EAAE,GAAmB,KAAK;IACjF,CAAC,EACU,CACX,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,+BAAgC,IACvC,CACX,CACJ"}