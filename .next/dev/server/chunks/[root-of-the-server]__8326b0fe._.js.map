{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/thebi/biblical-truth-website/app/api/agent/email-inbound/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { neon } from '@neondatabase/serverless';\n\nconst sql = neon(process.env.POSTGRES_URL!);\n\nconst EMAIL_SYSTEM_PROMPT = `You are Adam, the founder of The Biblical Man. You are responding to an email from a customer or potential member.\n\nPERSONALITY:\n- Direct, challenging, no-nonsense (Gary V style but biblical)\n- Use biblical references when relevant (KJV)\n- Don't coddle or validate weak excuses\n- Short, punchy sentences\n- Sign off with \"In the fight, Adam\"\n\nGOAL:\n- Answer their question directly but challenge the underlying mindset if it's weak.\n- If they are having technical issues, be helpful but brief.\n- If they are asking about products, guide them to the War Room ($3) or Vault ($297).\n\nCONTEXT:\n- The user has sent an email. You are drafting the reply.\n- Do not include the subject line in your response, just the body.\n`;\n\nexport async function POST(request: Request) {\n    let aiDraft = '';\n    try {\n        const { sender, subject, body } = await request.json();\n        const apiKey = process.env.ANTHROPIC_API_KEY;\n\n        if (!apiKey) {\n            return NextResponse.json({ error: 'No API key configured' }, { status: 500 });\n        }\n\n        // 1. Call Anthropic to generate draft\n        const response = await fetch('https://api.anthropic.com/v1/messages', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'x-api-key': apiKey,\n                'anthropic-version': '2023-06-01'\n            },\n            body: JSON.stringify({\n                model: 'claude-3-haiku-20240307',\n                max_tokens: 1000,\n                system: EMAIL_SYSTEM_PROMPT,\n                messages: [\n                    { role: 'user', content: `Sender: ${sender}\\nSubject: ${subject}\\n\\nBody:\\n${body}` }\n                ]\n            })\n        });\n\n        if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(`Anthropic API error: ${JSON.stringify(errorData)}`);\n        }\n\n        const data = await response.json();\n        aiDraft = data.content[0].text;\n\n        // 2. Save to Database (Non-blocking for response if it fails)\n        try {\n            await sql`\n                INSERT INTO email_drafts (sender_email, subject, body_text, ai_draft, status)\n                VALUES (${sender}, ${subject}, ${body}, ${aiDraft}, 'pending')\n            `;\n        } catch (dbError) {\n            console.error('DB Save Failed:', dbError);\n            // Continue to return the draft, potentially with a warning\n            return NextResponse.json({ success: true, draft: aiDraft, warning: 'Database save failed' }, { status: 200 });\n        }\n\n        return NextResponse.json({ success: true, draft: aiDraft });\n\n    } catch (error: any) {\n        console.error('Agent Error:', error);\n        // If an error occurred before aiDraft was successfully generated, return a 500 error.\n        // If aiDraft was generated but DB save failed, that's handled by the inner catch.\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,MAAM,IAAA,gMAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;AAEzC,MAAM,sBAAsB,CAAC;;;;;;;;;;;;;;;;;AAiB7B,CAAC;AAEM,eAAe,KAAK,OAAgB;IACvC,IAAI,UAAU;IACd,IAAI;QACA,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,IAAI;QACpD,MAAM,SAAS,QAAQ,GAAG,CAAC,iBAAiB;QAE5C,IAAI,CAAC,QAAQ;YACT,OAAO,gLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,sCAAsC;QACtC,MAAM,WAAW,MAAM,MAAM,yCAAyC;YAClE,QAAQ;YACR,SAAS;gBACL,gBAAgB;gBAChB,aAAa;gBACb,qBAAqB;YACzB;YACA,MAAM,KAAK,SAAS,CAAC;gBACjB,OAAO;gBACP,YAAY;gBACZ,QAAQ;gBACR,UAAU;oBACN;wBAAE,MAAM;wBAAQ,SAAS,CAAC,QAAQ,EAAE,OAAO,WAAW,EAAE,QAAQ,WAAW,EAAE,MAAM;oBAAC;iBACvF;YACL;QACJ;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YACd,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,MAAM,IAAI,MAAM,CAAC,qBAAqB,EAAE,KAAK,SAAS,CAAC,YAAY;QACvE;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,UAAU,KAAK,OAAO,CAAC,EAAE,CAAC,IAAI;QAE9B,8DAA8D;QAC9D,IAAI;YACA,MAAM,GAAG,CAAC;;wBAEE,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,EAAE,KAAK,EAAE,EAAE,QAAQ;YACtD,CAAC;QACL,EAAE,OAAO,SAAS;YACd,QAAQ,KAAK,CAAC,mBAAmB;YACjC,2DAA2D;YAC3D,OAAO,gLAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,OAAO;gBAAS,SAAS;YAAuB,GAAG;gBAAE,QAAQ;YAAI;QAC/G;QAEA,OAAO,gLAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,OAAO;QAAQ;IAE7D,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,sFAAsF;QACtF,kFAAkF;QAClF,OAAO,gLAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE;AACJ"}}]
}